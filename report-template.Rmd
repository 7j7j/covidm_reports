---
author: "LSHTM CMMID COVID-19 Working Group"
date: "`r format(Sys.Date(),'%d %b %Y')`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    toc: false
    citation_package: natbib
    latex_engine: xelatex
    fig_crop: no
mainfont: Arial
geometry:
 - top=10mm
 - left=12mm
 - right=12mm
 - bottom=15mm
params:
  location: Default
  unmitigated: "`r data.frame()`"
  peaks: "`r data.frame()`"
  accs: "`r data.frame()`"
  alls: "`r data.frame()`"
  contactmatrices: "`r matrix()`"
  poppyra: "`r integer()`"
  plothelpers: "`r character()`"
  is_analogy: "`r NA_character_`"
title: "`r sprintf('Modelling projections for COVID-19 epidemic in %s', params$location)`"
bibliography: COVID.bib
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage[square,numbers,sort&compress]{natbib}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
editor_options: 
  chunk_output_type: console
---
```{r echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r echo=FALSE, include=FALSE}
suppressPackageStartupMessages({
  require(data.table)
  require(ggplot2)
  require(ggthemr)
  require(cowplot)
  require(knitr)
  require(tidyverse)
  require(RColorBrewer)
  require(kableExtra)
})

for (ph in params$plothelpers) {
  if (grepl("rda$", ph)) {
    load(ph)
  } else if (grepl("R$", ph)) {
    source(ph)
  }
}

alls.dt <- params$alls[scen_id %in% c(1,scens)]

milestones <- c(90,180,270,360)
sizerefs <- c(M=6, K=3, 0)
mk <- function(v) {
  i <- which.max(log10(v) >= sizerefs)
  sprintf("%g%s",signif(v/(10^sizerefs[i]),2),names(sizerefs)[i])
}
pasteAnd <- function(v, oxford = TRUE) {
  if (length(v) <= 2) {
    paste(v, collapse = " and ")
  } else {
    opening <- paste(head(v,-1), collapse = ", ")
    if (oxford) opening <- sprintf("%s,",opening)
    pasteAnd(c(opening, tail(v,1)))
  }
}
boldL <- function(kbl) column_spec(row_spec(kbl, 0, bold = TRUE), 1, bold = TRUE)
typicalfmt <- "%s~~(%s)"
```

# Overview

This report provides simulation-based estimates for COVID-19 epidemic scenarios in `r params$location`. In this model, we use a population of `r mk(sum(params$poppyra$pop))` in `r params$location`, with an average age of `r signif(params$poppyra[, sum(per_by_group[-.N]*seq(2,by=5,length.out = .N-1))+per_by_group[.N]*87.5], 3)`, based on [@wpp;@wpprepo].

- We use a stochastic age-structured dynamic transmission model to project the COVID-19 epidemic in `r params$location`.
- We consider scenarios for an unmitigated epidemic (*i.e.*, no intervention), and combinations of social distancing and shielding interventions to decrease transmission.
- We estimate predicted peak counts and timing for `r params$location` in new symptomatic cases and deaths per day, and total hospital bed need each day. We calculate the impact of  interventions relative to an unmitigated epidemic.
- Transmission parameters, including severity and hospitalisation rates, are based on global outbreak data, which have primarily been observed in Asia, Europe, and North America. These values implicitly assume risk factor rates and health service system effectiveness which may not apply generally in lower-middle income settings.
- Population parameters are based on demographics of `r params$location` and estimated contact matrices, and assume a single national population
- We assume the outbreak is seeded with 50 initial infections, proportionally distributed according to the age demography of `r params$location`. We refer to this day 0 as the *initial introduction*. So dates should be counted from when `r params$location` reaches 50 cases.
- Numerical results are reported to two significant figures, and interquartile and 95% intervals are reported.
- These reports will be updated as information changes, and if locally-specific information on hospitalisation rates become available.
- Modelling methods and parameters are given at the end of the report.


# Unmitigated COVID-19 Epidemic Trajectory

The panels in Fig. \@ref(fig:tsunmit) show aggregate and by-age group outcomes for daily incidence of COVID-19 cases and deaths in `r params$location`, and daily demand for hospital care. The ranges for peak timing and values for those outcomes is summarised in Table \@ref(tab:unpeakstable) (by 50% and 95% forecast intervals); Table \@ref(tab:uncumulative1) covers total counts by `r pasteAnd(milestones/30)` months from initial introduction in `r params$location`.

```{r}
unmit.q <- meltquantiles(params$alls[scen_id == 1])
unmit.q$age <- factor(unmit.q$age, levels = levels(unmit.q$age)[c(6,5,1:4)], ordered = TRUE)
reage <- function(a, lvls = levels(unmit.q$age)) factor(a, levels = lvls, ordered = TRUE)
unmit.q$compartment <- factor(unmit.q$compartment, levels = levels(unmit.q$compartment)[c(1,5,3:4,2)], ordered = TRUE)
recomp <- function(cmp, lvls = levels(unmit.q$compartment)) factor(cmp, levels = lvls, ordered = TRUE)

reord <- function(dt) dt[, age := reage(age) ][, compartment := recomp(compartment) ]

unmit.pks <- params$alls[scen_id == 1][,{
  res <- apply(.SD, 2, max)
  names(res) <- colnames(.SD)
  as.list(res)
}, by=.(compartment, age, scen_id)]
reord(unmit.pks)

quotepeaks <- unmit.pks[age == "all"]

up <- function(v, sf = 2) {
  if (length(v) && v!=0) {
  ref <- max(floor(log10(v))-(sf-1),0)
  ceiling(v/(10^ref))*(10^ref) } else v
}

down <- function(v, sf = 2) {
  if (length(v)) {
    if (v>0) {
      ref <- max(floor(log10(v))-(sf-1),0)
      floor(v/(10^ref))*(10^ref)
    } else if (v<0) {
      -up(-v, sf)
    } else v
  } else v
}

rngprint <- function(r, prefix="") {
  ifelse(down(r[1])==up(r[2]),format(signif(r[1],2),big.mark = ",",scientific = FALSE), sprintf("%s%s - %s",prefix,format(down(r[1]), big.mark = ",",scientific = FALSE), format(up(r[2]),  big.mark = ",",scientific = FALSE)))
}
bullettext <- function(filterdt) {
  paste0(rngprint(filterdt[,c(lo,hi)],"between ")," (95%: ",rngprint(filterdt[,c(lo.lo,hi.hi)]),")")
}
tabltext <- function(filterdt) {
  sprintf(typicalfmt, rngprint(filterdt[,c(lo,hi)]), rngprint(filterdt[,c(lo.lo,hi.hi)]))
}
outcomesc <- params$alls[
  scen_id == 1 & age == "all"][,{
  vs <- colSums(.SD)
  names(vs) <- colnames(.SD)
  as.list(vs)
  },by=compartment,.SDcols = -c("age", "t", "scen_id")
]
outcomest <- params$alls[
  scen_id == 1 & age == "all"][,{
  vs <- t[apply(.SD, 2, which.max)]
  names(vs) <- rev(colnames(.SD))
  as.list(vs)
  },by=compartment,.SDcols = -c("age", "t", "scen_id")
]
```

In an unmitigated epidemic, we anticipate that in `r params$location`, one year after the initial introduction, the total number of symptomatic cases will have been `r bullettext(outcomesc[compartment == "cases"])`, the total deaths `r bullettext(outcomesc[compartment == "death_o"])`, and total hospitalised bed-days `r bullettext(outcomesc[compartment == "hosp_p"])` with `r bullettext(outcomesc[compartment == "icu_p"])` of those bed-days requiring critical care facilities. Table \@ref(tab:sumtable) shows the size and timing of peaks for these main outcomes.

```{r sumtable}
tabl <- data.table(
  `Outcome` = c(
    "Incidence of Symptomatic Cases",
    "All Hospital Occupancy",
    "General Hospital Occupancy",
    "Critical Care Occupancy",
    "Incidence of Deaths"
  ),
  `Peak Day IQR (95\\% interval)` = c(
    tabltext(outcomest[compartment == "cases"]),
    tabltext(outcomest[compartment == "hosp_p"]),
    tabltext(outcomest[compartment == "nonicu_p"]),
    tabltext(outcomest[compartment == "icu_p"]),
    tabltext(outcomest[compartment == "death_o"])
  ),
  `Peak Number IQR (95\\% interval)` = c(
    tabltext(quotepeaks[compartment == "cases"]),
    tabltext(quotepeaks[compartment == "hosp_p"]),
    tabltext(quotepeaks[compartment == "nonicu_p"]),
    tabltext(quotepeaks[compartment == "icu_p"]),
    tabltext(quotepeaks[compartment == "death_o"])
  )
)
boldL(kable_styling(
  kable(
    tabl,
    caption=sprintf("Overview of estimated peak impacts based on the population in %s. Rates of symptoms and severe outcomes are based on global outbreak data, which have primarily been observed in Asia, Europe, and North America. Timing is in days from initial introduction to %s.", params$location, params$location),
    booktabs = TRUE, escape = FALSE
  ),
  latex_options = c("striped","hold_position")
))
```

\blandscape

```{r tsunmit, fig.height=6, out.width="10in", fig.width=10, fig.cap=sprintf("Unmitigated epidemics in %s. Time series and peak sizes for incidence of symptomatic cases, incidence of deaths, general ward hospital occupancy, critical care hospital occupancy, and total hospital occupancy (general ward plus critical care). Both summary and by age group results are provided; population on underlying age groups from demography of %s.", params$location, params$location)}

age.annotate <- function(l) sprintf("%s\n%s",l,ifelse(l=="all","ages","years"))
stagger <- function(l) {
  l[seq(1,length(l),by=2)] <- sprintf("%s\n", l[seq(1,length(l),by=2)])
  l[seq(2,length(l),by=2)] <- sprintf("\n%s", l[seq(2,length(l),by=2)])
  l
}

xscale <- scale_x_t(sprintf("Months since initial introduction in %s", params$location), labels = function(b) sprintf("%i\n", b/30), breaks = milestones)

sharedelements <- list(
  scale_color_discrete(guide = "none"),
  scale_alpha_quantile(),
  theme_minimal(base_size = 10),
  theme(
    panel.spacing.y = unit(12, "pt")
  )
)

plot_grid(ggplotqs(unmit.q, aes(
  alpha = variable,
  color = "Unmitigated"
)) +
  facet_grid(
    compartment ~ age,
    scale = "free_y", labeller = fct_labels(
      age = age.annotate
    ),
    switch = "y"
  ) +
  sharedelements +
  xscale +
  coord_cartesian(ylim = c(0, NA), expand = F) +
  theme(
    strip.placement = "outside",
    axis.title.y = element_blank(),
    plot.margin = margin(l = 12)
  ),
int.peaks.all(unmit.pks, aes(x=age), range.scale = c(1, 1.5, 2)) + facet_grid(
  compartment ~ "\nPeak Values", scales = "free_y"
) +
  scale_x_discrete("Age Group", labels = age.annotate) +
  sharedelements +
  theme(
      axis.title.x = element_text(),
      axis.text.x = element_text(),
      axis.title.y = element_blank(),
      strip.text.y = element_blank(),
      plot.margin = margin(r=12)
    ),
  axis = "l", align = "v", rel_widths = c(3, 2)
)
```

\elandscape

```{r unpeakstable}
tabpeak <- alls.dt[scen_id == 1,{
  v.ll = max(lo.lo); t.ll = t[which.max(lo.lo)]
  v.lo = max(lo); t.lo = t[which.max(lo)]
  v.md = max(med); t.md = t[which.max(med)]
  v.hi = max(hi); t.hi = t[which.max(hi)]
  v.hh = max(hi.hi); t.hh = t[which.max(hi.hi)]
  .(
    t=sprintf(typicalfmt, rngprint(c(t.hi,t.lo)), rngprint(c(t.hh, t.ll))),
    v=sprintf(typicalfmt, rngprint(c(v.lo,v.hi)), rngprint(c(v.ll,v.hh)))
  )},
  by=.(age, compartment)
]
reord(tabpeak)

tabpeak <- tabpeak[order(compartment, age),.(
  `Peaks`=c(
    cases="Incident Cases",
    death_o="Incident Deaths",
    hosp_p="Hospital Occupancy",
    nonicu_p="Non-critical Occupancy",
    icu_p="Critical Occupancy"
  )[as.character(compartment)],
  `Age Group`=sprintf("%s %s",as.character(age),ifelse(age=="all","ages","years")),
  `Peak Day, IQR (95\\% interval)`=t,
  `Peak Number, IQR (95\\% interval)`=v
)]

mkkbl <- function(tbl, b = TRUE, ...) boldL(row_spec(
  collapse_rows(
  kable(
    tbl,
    ...
    ), columns = 1, latex_hline = "major"
  ),
  seq(1, by=length(unique(tbl[[2]])), length.out = length(unique(tbl[[1]]))), bold = b
))

mkkbl(
  tabpeak,
  caption=sprintf("Peak timing and values for main outcomes in %s for the unmitigated scenario, by age group. Timing is from the date of initial introduction.", params$location),
  escape = FALSE
)
```

```{r uncumulative1}
outcome_cumulative <- c(
    cases="Cases",
    death_o="Deaths",
    hosp_p="Hospital\nBed-Days",
    nonicu_p="Non-critical\nBed-Days",
    icu_p="Critical\nBed-Days",
    E="Infections"
  )

unmitacc <- params$unmitigated[compartment != "E"][
  order(t),.(t, value=cumsum(value)),by=.(run, age, compartment)
][t %in% milestones,{
  qs <- quantile(value, probs = refprobs)
  iqr <- rngprint(qs[c(2,4)])
  i95 <- rngprint(qs[c(1,5)])
  sprintf(typicalfmt, iqr, i95)
},by=.(age, compartment, t)]

reord(unmitacc)

unmitacctable1 <- dcast(unmitacc, age + compartment ~ t, value.var="V1")[
order(compartment, age),.(
  `Totals`=linebreak(outcome_cumulative[as.character(compartment)]),
  `Age Group`=sprintf("%s %s",as.character(age),ifelse(age=="all","ages","years")),
  `3 months`=`90`,
  `6 months`=`180`,
  `9 months`=`270`,
  `12 months`=`360`
)
]

landscape(mkkbl(
    unmitacctable1,
    caption=sprintf("Total counts for main outcomes in %s for the unmitigated scenario, by age group; counts are evaluated at %s months from initial introduction.", params$location, pasteAnd(milestones/30)),
    escape = FALSE
))
```

# Intervention Scenarios

The panels in Fig. \@ref(fig:tsintervention) compare unmitigated epidemics with 5 different potential interventions in `r params$location`. The quantiles for peak timing and values for those outcomes are summarised in Table \@ref(tab:intpeakstable); Table \@ref(tab:intcumulative1) covers cumulative reductions due to the interventions at `r pasteAnd(milestones/30)` months from initial introduction.

- We assumed these interventions are applied at the country level.
- General physical distancing was implemented as a reduction in transmission for all contacts outside the household. We assumed no change in transmission within the household, despite some potential benefits (e.g., improved WASH compliance).
- Shielding was implemented by stratifying the population in one shielded and one unshielded compartment. Shielding applies to those aged 60+ years, and we assume the adoption rate is 80%. In `r params$location`, this 80% corresponds to `r mk(params$poppyra[age == "60+", sum(pop)*.8])` individuals  or `r mk(params$poppyra[age == "60+", round(unique(per_by_age)*.8*100)])`% of the population. In the presence of shielding, mixing between the shielded and unshielded population reduces by 80%. To be effective, shielding must be maintained until the epidemic is over and must ensure that there is not increased mixing amongst the shielded population.
```{r}
effref <- params$accs[compartment != "E"][metric == "effectiveness" & age == "all" & t == 360 & scen_id %in% scens]
reord(effref)
#redref <- params$accs[compartment != "E"][metric == "reduction" & age == "all" & t == 360 & scen_id %in% scens]
#reord(redref)
#redref[, longname := int.factorize(scen_id) ]
efftext <- function(r) {
  v <- round(r*100)
  sprintf("%i-%i\\%% (%i-%i\\%%)",v[2],v[4],v[1],v[5])
}
efftab <- dcast(
  effref[,.(etext=efftext(c(lo.lo,lo,med,hi,hi.hi))),keyby=.(scen_id, compartment)],
  linebreak(outcome_cumulative[as.character(compartment)]) ~ linebreak(gsub("%","\\%",gsub(" &\n"," and\n",int.factorize(scen_id), fixed = T), fixed = T)), value.var = "etext"
)
colnames(efftab)[1] <- "Total"
#redtab <- redref[,.(rtext=sprintf("%s (%s)",rngprint(c(lo,hi)), rngprint(c(lo.lo,hi.hi)))),keyby=.(scen_id, compartment)]
# intbulltext <- function(sid, cmp) {
#   paste0(bullettext(redref[scen_id == sid & compartment == cmp]),"; % reduction: ", efftext(effref[scen_id == sid & compartment == cmp,c(lo.lo,lo,med,hi,hi.hi)]))
# }
```
The % net reduction to cases, deaths, and hospitalised person-days in these scenarios, one year after initial introduction in `r params$location` is summarised in Table \@ref(tab:intsumtabl):

```{r intsumtabl}
boldL(kable_styling(
  kable(
    efftab, booktabs = TRUE, caption = "Scenario Effectiveness Summary",
    escape = FALSE
  ),
  latex_options = c("striped", "hold_position")
))
```

\blandscape

```{r tsintervention, fig.height=6, out.width="10in", fig.width=10, fig.cap=sprintf("Epidemics in %s with interventions for all ages. Time series and peak counts for incidence of symptomatic cases, incidence of deaths, general ward hospital occupancy, critical care hospital occupancy, and total hospital occupancy (general ward plus critical care).", params$location)}
pks <- alls.dt[age=="all",{
  res <- apply(.SD, 2, max)
  names(res) <- colnames(.SD)
  as.list(res)
}, by=.(compartment, age, scen_id)]
reord(pks)

sharedelements <- list(
  scale_alpha_quantile(),
  coord_cartesian(ylim = c(0, NA), expand = F),
  theme_minimal(base_size = 10),
  theme(
    panel.spacing.y = unit(12, "pt")
  )
)

int.qs <- meltquantiles(alls.dt[age=="all"])
reord(int.qs)

plot_grid(
ggplotqs(int.qs, aes(
   color=factor(scen_id), group=variable, alpha=variable
)) +
  facet_grid(compartment ~ scen_id, scale = "free_y", switch = "y", labeller = fct_labels(
    scen_id = { res <- levels(int.factorize(c(1, scens))); names(res) <- c(1, scens); res }
  )) +
  xscale +
  scale_color_discrete(guide = "none") +
  sharedelements +
  theme(
    strip.placement = "outside",
    axis.title.y = element_blank(),
    plot.margin = margin(l = 12)
  ),
int.peaks.all(pks, range.scale = c(1, 1.5, 2)) + facet_grid(
  compartment ~ "\nPeak Values", scales = "free_y", labeller = labeller(compartment = function(l) rep("",length(l)))
) + sharedelements +
  scale_x_discrete("\n", labels = function(bs) rep("", length(bs))) +
  theme(
      axis.title.x = element_text(),
      axis.text.x = element_text(),
      axis.title.y = element_blank(),
      legend.key.size = unit(24, "pt"),
      strip.text.y = element_blank(),
      plot.margin = margin()
    ),
  axis = "l", align = "v", rel_widths = c(3, 2)
)
```

\elandscape

```{r intpeakstable}
tabpeak <- alls.dt[age=="all",{
  v.ll = max(lo.lo); t.ll = t[which.max(lo.lo)]
  v.lo = max(lo); t.lo = t[which.max(lo)]
  v.md = max(med); t.md = t[which.max(med)]
  v.hi = max(hi); t.hi = t[which.max(hi)]
  v.hh = max(hi.hi); t.hh = t[which.max(hi.hi)]
  .(
    t=sprintf(typicalfmt, rngprint(c(t.hi,t.lo)), rngprint(c(t.hh, t.ll))),
    v=sprintf(typicalfmt, rngprint(c(v.lo,v.hi)), rngprint(c(v.ll,v.hh)))
  )},
  by=.(scenario=scen_id, compartment, age)
]
reord(tabpeak)

inttab <- tabpeak[order(scenario, compartment)][,.(
  Scenario=linebreak(gsub("%","\\%",gsub(" &\n"," and\n",int.factorize(scenario), fixed = T), fixed = T)),
  `All ages`=c(
    cases="Incident Cases",
    death_o="Incident Deaths",
    hosp_p="Hospital Occupancy",
    nonicu_p="Non-critical Occupancy",
    icu_p="Critical Occupancy"
  )[as.character(compartment)],
  `Peak day IQR (95\\% interval)`=t,
  `Peak number IQR (95\\% interval)`=v
)]

mkkbl(inttab, caption=sprintf("Peak timing and values for main outcomes in %s, by intervention scenario. Timing is from the date of ongoing community spread with 50 infections.", params$location), b = FALSE, escape = FALSE)
```

```{r intcumulative1}
intacc <- params$accs[compartment != "E"][metric == "reduction" & age == "all" & scen_id %in% scens][,{
  iqr <- rngprint(c(lo, hi))
  i95 <- rngprint(c(lo.lo,hi.hi))
  sprintf(typicalfmt, iqr, i95)
},by=.(age, compartment, t, scen_id)]

reord(intacc)

intacctable1 <- dcast(intacc, scen_id + compartment ~ t, value.var="V1")[order(scen_id, compartment)][
,.(
  Scenario=linebreak(gsub("%","\\%",gsub(" &\n"," and\n",int.factorize(scen_id), fixed = T), fixed = T)),
  Outcome=gsub("\\n"," ",outcome_cumulative)[as.character(compartment)],
  `3 months`=`90`,
  `6 months`=`180`,
  `9 months`=`270`,
  `12 months`=`360`
)
]

landscape(mkkbl(
  intacctable1,
  caption=sprintf("Net reductions for main outcomes in %s by intervention scenario; reductions are evaluated at %s months.", params$location, pasteAnd(milestones/30)),
  escape = FALSE,
  b = FALSE
))
```

# Methods, data and assumptions

We used the stochastic age-structured dynamic transmission model reported in [@davies2020].

## Dynamic transmission model 

We used a stochastic compartmental model stratified into 5-year age bands, with individuals classified according to current disease status (Fig. \@ref(fig:modelpars))) and transmission between groups based on social mixing patterns [@daviesage2020;@mossong2008social]. After infection with SARS-CoV-2 in the model, susceptible individuals pass through a latent period before becoming infectious, either with a preclinical and then clinical infection, or with a subclinical infection, before recovery or isolation. We refer to those infections causing few or no symptoms as subclinical. We assume older individuals are more likely to show clinical symptoms [@daviesage2020].

```{r modelpars, echo=FALSE, fig.height=2.5, fig.cap=sprintf("Population Structure%s", ifelse(is.na(params$is_analogy), "", paste0("; contact matrix based on ",params$is_analogy))) }
plotter <- function(pop) {
  p <- ggplot(pop) +
    aes(x = age, y = pop / 1000) +
    geom_col(fill = "#cc3366") +
    coord_flip() +
    labs(x = NULL, y = "Population (thousands)") +
    theme_minimal()
  return(p)
}
sp_contact_matrices <- function(mat, legpos = "right", is_analogy = params$is_analogy) {
  mat <- Reduce(function(l, r) l + r, mat)
  data <- data.table(reshape2::melt(mat))
  names(data) <- c("From", "To", "Contacts")
  ggplot(data) +
    geom_raster(aes(x = To, y = From, fill = Contacts)) +
    scale_fill_viridis_c() +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
      strip.background = element_rect(fill = "white", colour = "white"),
      legend.position = legpos,
    )
}
plot_grid(plotter(poppyra), sp_contact_matrices(params$contactmatrices), ncol = 2)
```

## Key model parameters 

We collated multiple sources of evidence to estimate key model parameters (Table \@ref(tab:parameters)). In a meta-analysis, we estimated that the basic reproduction number, $R_0$, was 2.7 (95% credible interval: 1.6–3.9) across settings without substantial control measures in place ($R_0$ describes the average number of secondary infections caused by a typical primary infection in a completely susceptible population). We derived age-stratified case fatality ratios (CFR) to estimate a CFR that ranged substantially across age groups, from 0.1% in the 20–29 age group to 7.7% in the over-80 age group. For all model parameters, their values or distributions are given in Table \@ref(tab:parameters)
<!-- and the distributions of variable parameters are shown in Fig. \@ref(fig:parameterdistributions). -->


<!-- ```{r parameterdistributions, echo=FALSE, fig.height=8, fig.cap="Model Parameter Distributions."} -->
<!-- plot_all_parameters() -->
<!-- ``` -->


```{r echo=FALSE}
parameter_set_df <- data.frame(matrix(c(
  "Basic reproductive rate", "$R_0$", "Sampled PERT distribution", "$\\mu = 2.7$", "1.6–3.9", "assumed",
  "Age-specific clinical fraction", "$y_i$", "Fixed", "Age-dependent", "0.1-0.2", "\\citep{daviesage2020}",
  "Relative infectiousness\nof subclinical cases", "$f$", "Fixed", "$0.5*y_i$", "0.1-0.5", "\\citep{daviesage2020}",
  "Case fatality ratio", "CFR", "Normal", "$\\mu = 0.5$", "0.001-0.077", "assumed",
  "Serial interval", "SI", "Normal", "$\\mu = 6.5$, $\\sigma = 2.7$", "5.5-7.6 days", "\\citep{li2020early, bi2020epidemiology, nishiura2020serial}",
  "Length of preclinical period", "l", "Fixed", "30\\%", "0.3", "\\citep{liu2020contribution}",
  "Mean latent period", "p", "Fixed", "4 days", "4", "\\citep{liu2020contribution}",
  "Mean duration of\npreclinical infectiousness", "$t_p$", "Fixed", "1.5", "1.5 days", "\\citep{liu2020contribution}",
  "Mean duration of\nclinical infectiousness", "$t_c$", "Fixed", "3.5", "1.5 days", "\\citep{liu2020contribution}",
  "Mean latent period", "p", "Fixed", "4 days", "4", "\\citep{liu2020contribution}",
  "Delay from symptom\nonset to hospitilisation", "$d_h$", "Gamma", paste0("$k=7$, $\\Theta=", round(7 / 2.65^2, 2), "$"), paste0(round(qgamma(0.025, shape = 7, scale = 8 / 2.83^2)), "-", round(qgamma(0.975, shape = 7, scale = 7 / 2.65^2), 2), " days"), "\\citep{linton2020incubation, cao2020trial}",
  "Delay from hospitilisation\nto discharge/death (non-ICU)", "$d_d$", "Gamma", paste0("$k=8$, $\\Theta=", round(8 / 2.83^2, 2), "$"), paste0(round(qgamma(0.025, shape = 8, scale = 8 / 2.83^2)), "-", round(qgamma(0.975, shape = 8, scale = 8 / 2.83^2), 2), " days"), "\\citep{NHSDigital}",
  "Delay from hospitilisation\nto discharge/death (ICU)", "$d_{icu}$", "Gamma", paste0("$k=10$, $\\Theta=", round(10 / 3.16^2, 2), "$"), paste0(round(qgamma(0.025, shape = 10, scale = 3.16)), "-", round(qgamma(0.975, shape = 10, scale = 10 / 3.16^2), 2), " days"), "\\citep{cao2020trial}",
  "Delay from onset\nto death (ICU)", "$d_{tot}$", "Gamma", paste0("$k=22$, $\\Theta=", round(22 / 4.69^2, 2), "$"), paste0(round(qgamma(0.025, shape = 22, scale = 22 / 4.69^2)), "-", round(qgamma(0.975, shape = 22, scale = 22 / 4.69^2), 2), " days"), "\\citep{linton2020incubation, cao2020trial}"
),
ncol = 6, byrow = TRUE
))
names(parameter_set_df) <- c("Short English Name", "Abbrv.", "Assumed Distribution", "Distribution Parameters", "95\\% CI", "References")
parameter_set_df %>%
  # select(-References) %>%
  mutate_all(linebreak) %>%
  # mutate(References="\\citep{daviesage2020}") %>%
  # mutate(References="\\citep{liu2020contribution}") %>%
  knitr::kable("latex", booktabs = TRUE, escape = FALSE, caption = "Parameters used in the models and descriptions of their distributions and sources.", label = "parameters") %>%
  kableExtra::kable_styling(latex_options = "scale_down")
```


## Key parameters of the transmission model 

We used a serial interval of 6.5 days based on published studies [@li2020early;@bi2020epidemiology;@nishiura2020serial], and assumed that the length of the preclinical period was 30% of the total period of clinical infectiousness [@liu2020contribution]. From this, we fixed the mean of the latent period to 4 days, the mean duration of preclinical infectiousness to 1.5 days, and the mean duration of clinical infectiousness to 3.5 days. The basic reproduction number $R_0$ was estimated by synthesizing the results of a literature review (Fig. S1). For each reported value of the basic reproduction number, we matched a flexible PERT distribution (a shifted beta distribution parameterised by minimum, maximum, and mode) to the median and confidence interval reported in each study. We sampled from the resulting distributions, weighting each study equally, to obtain estimates of $R_0$ for our simulations. The age-specific clinical fraction, $y_i$, was adopted from an estimate based on case data from 6 countries [@daviesage2020], and the relative infectiousness of subclinical cases, $f$, was assumed to be 50% relative to clinical cases, as we assumed in a previous study [@daviesage2020].

## Hospital burden estimation

To calculate ICU and non-ICU beds in use through time, we scaled age-stratified symptomatic cases by age-specific hospitalisation and critical outcome probability, then summed to get the total number of hospitalised and critical cases. We then distributed hospitalised cases over time based on expected time of hospitalisation and duration admitted. We assumed gamma-distributed delays, with the shape parameter set equal to the mean, for: delay from symptom onset to hospitalisation of mean 7 days (standard deviation 2.65) [@linton2020incubation;@cao2020trial]; delay from hospitalisation to discharge / death for non-ICU patients of mean 8 days (s.d. 2.83) [@NHSDigital]; delay from hospitalisation to discharge / death for ICU patients of mean 10 days (s.d. 3.16) [@cao2020trial]; and delay from onset to death of mean 22 days (s.d. 4.69) [@linton2020incubation;@cao2020trial]. We calculated the age-specific case fatality ratio based on data from the COVID-19 outbreak in China and on the Diamond Princess cruise ship. We first calculated the naive case fatality ratio, nCFR, (i.e. deaths/cases) for each age group, then scaled down the naive CFR based on a correction factor estimated from data from the Diamond Princess [@russell2020] to give an adjusted CFR. We then calculated risk of hospitalisation based on the ratio of severe and critical cases to cases (18.5%) and deaths to cases (2.3%) in the early China data, which we took to imply 8.04 times more hospitalisations than deaths in each age group. We assumed all age groups had a 30% risk of requiring critical care if hospitalised [@cao2020trial].”

# References
